**Compiled Queries** в Entity Framework Core — це механізм, який дозволяє кешувати процес створення запиту, щоб підвищити продуктивність для часто виконуваних операцій.

### Що таке Compiled Queries?

Коли ви виконуєте LINQ-запит у EF Core, він проходить кілька етапів:

1. **Парсинг LINQ-запиту:** Перетворення LINQ-виразу в дерево виразів.
2. **Перетворення в SQL:** Композиція дерева виразів у SQL-запит.
3. **Кешування метаданих:** Завантаження і кешування моделі (наприклад, інформації про зв’язки між таблицями).
4. **Виконання SQL-запиту.**

Ці перші етапи потребують ресурсів, особливо для складних запитів, але їх можна уникнути для повторюваних операцій за допомогою **Compiled Queries**.

### Як працюють Compiled Queries?

**Compiled Queries** дозволяють зберігати результат парсингу LINQ-запиту (його SQL-еквівалент) і використовувати його повторно для наступних виконань. Це особливо корисно в сценаріях, де запити виконуються багато разів із різними параметрами.

---

### Реалізація Compiled Queries

#### 1. **Використання `EF.CompileQuery`**

```csharp
using Microsoft.EntityFrameworkCore;

public static readonly Func<MyDbContext, int, IEnumerable<MyEntity>> GetEntitiesByValue =
    EF.CompileQuery((MyDbContext context, int minValue) =>
        context.MyEntities.Where(e => e.Value > minValue));
```

- **Опис**:
    - `EF.CompileQuery` приймає вираз запиту (`Expression<Func>`) і компілює його.
    - Першим параметром завжди передається контекст (`DbContext`), а далі можуть бути довільні параметри.

#### Використання:

```csharp
using (var context = new MyDbContext())
{
    var result = GetEntitiesByValue(context, 10); // Запит для minValue = 10
}
```

#### 2. **Використання `EF.CompileAsyncQuery`** для асинхронних запитів:

```csharp
public static readonly Func<MyDbContext, int, Task<IEnumerable<MyEntity>>> GetEntitiesByValueAsync =
    EF.CompileAsyncQuery((MyDbContext context, int minValue) =>
        context.MyEntities.Where(e => e.Value > minValue));
```

---

### Переваги Compiled Queries

1. **Підвищення продуктивності:**
    - Зменшення накладних витрат на компіляцію запитів.
2. **Оптимізація для повторюваних запитів:**
    - Запити, які часто виконуються (з різними параметрами), стають швидшими.
3. **Ефективне використання ресурсів:**
    - Зменшується об’єм тимчасових ресурсів, необхідних для обробки запитів.

---

### Обмеження та недоліки

4. **Фіксованість запиту:**
    - Запит повинен бути статичним. Якщо потрібно змінювати структуру запиту (наприклад, додавати динамічні фільтри), це не підійде.
5. **Додаткова складність коду:**
    - Код із використанням `Compiled Queries` може виглядати складніше, ніж звичайні LINQ-запити.
6. **Незначний виграш для простих запитів:**
    - Для запитів, які виконуються рідко або є простими (наприклад, `context.Entities.ToList()`), вигода може бути мінімальною.
7. **Труднощі з відлагодженням:**
    - Помилки у виразах або параметрах можуть бути складнішими для діагностики.

---

### Коли використовувати Compiled Queries?

8. **Часто виконувані запити:**
    - Наприклад, пошук по ID або фільтрація даних на основі стандартних умов.
9. **Високонавантажені системи:**
    - У системах із великою кількістю запитів і вимогами до продуктивності.
10. **Кешовані дані:**
    - Коли важливо мінімізувати обробку запитів.

---

### Поради щодо використання

11. **Групуйте запити:**
    - Використовуйте `Compiled Queries` для запитів із чітко визначеними сценаріями.
12. **Не зловживайте:**
    - Якщо вигода в продуктивності незначна, краще дотримуватися стандартних підходів.
13. **Тестуйте продуктивність:**
    - Переконайтеся, що використання `Compiled Queries` дійсно надає виграш для ваших сценаріїв.

---

### Альтернативи Compiled Queries

14. **Кешування результатів запитів:**
    - Наприклад, використання бібліотек кешування (Redis, MemoryCache).
15. **Використання збережених процедур:**
    - Якщо бізнес-логіка дозволяє, можна створити та використовувати збережені процедури на стороні SQL Server.
16. **Підтримка IQueryable:**
    - Відкладіть виконання запиту до необхідного моменту.

---

Якщо потрібна демонстрація в реальному проекті або більш глибокий розбір специфіки, дай знати!