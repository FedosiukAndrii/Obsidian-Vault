### **–©–æ —Ç–∞–∫–µ `OutboxMessages`?**

`OutboxMessages` ‚Äî —Ü–µ **—Ç–∞–±–ª–∏—Ü—è –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö**, —è–∫–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –≤ **Outbox Pattern** –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø–æ–¥—ñ–π –ø–µ—Ä–µ–¥ —ó—Ö –ø–µ—Ä–µ–¥–∞—á–µ—é –≤ **—Å–∏—Å—Ç–µ–º–∏ –æ–±–º—ñ–Ω—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º–∏** (Kafka, RabbitMQ, Azure Service Bus —Ç–æ—â–æ).

–¶—è —Ç–∞–±–ª–∏—Ü—è –≤–∏–∫–æ–Ω—É—î —Ä–æ–ª—å **–±—É—Ñ–µ—Ä—É (transient storage)** –¥–ª—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å, —â–æ –¥–æ–∑–≤–æ–ª—è—î:

1. **–ó–∞–ø–∏—Å–∞—Ç–∏ –±—ñ–∑–Ω–µ—Å-–¥–∞–Ω—ñ —ñ –ø–æ–¥—ñ—é –≤ –æ–¥–Ω—ñ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó**.
2. **–ì–∞—Ä–∞–Ω—Ç—É–≤–∞—Ç–∏, —â–æ –ø–æ–¥—ñ—è –Ω–µ –±—É–¥–µ –≤—Ç—Ä–∞—á–µ–Ω–∞** —É —Ä–∞–∑—ñ –∑–±–æ—é —á–µ—Ä–≥–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å.
3. **–í—ñ–¥–ø—Ä–∞–≤–ª—è—Ç–∏ –ø–æ–¥—ñ—ó –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —á–µ—Ä–µ–∑ —Ñ–æ–Ω–æ–≤–∏–π –ø—Ä–æ—Ü–µ—Å**.
4. **–ó–∞–±–µ–∑–ø–µ—á–∏—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–µ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è**, —è–∫—â–æ –ø–µ—Ä—à–∞ —Å–ø—Ä–æ–±–∞ –Ω–µ –≤–¥–∞–ª–∞—Å—è.

---

## **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ñ `OutboxMessages`**

–í–æ–Ω–∞ –º—ñ—Å—Ç–∏—Ç—å —Ç–∞–∫—ñ –æ—Å–Ω–æ–≤–Ω—ñ –ø–æ–ª—è:

```csharp
public class OutboxMessage
{
    public Guid Id { get; set; } = Guid.NewGuid(); // –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –ø–æ–¥—ñ—ó
    public string EventType { get; set; } = null!; // –¢–∏–ø –ø–æ–¥—ñ—ó (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, OrderCreated, UserRegistered)
    public string Payload { get; set; } = null!;   // JSON-–¥–∞–Ω—ñ –ø–æ–¥—ñ—ó
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow; // –ß–∞—Å —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ–¥—ñ—ó
    public bool Processed { get; set; } = false;   // –ß–∏ –±—É–ª–∞ –ø–æ–¥—ñ—è –æ–±—Ä–æ–±–ª–µ–Ω–∞
    public DateTime? ProcessedAt { get; set; }     // –ß–∞—Å –æ–±—Ä–æ–±–∫–∏ –ø–æ–¥—ñ—ó (–∫–æ–ª–∏ –≤–æ–Ω–∞ –±—É–ª–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∞)
}
```

üìå **–û—Å–Ω–æ–≤–Ω—ñ –∞—Å–ø–µ–∫—Ç–∏:**

- **`Id`** ‚Äì –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –ø–æ–¥—ñ—ó.
- **`EventType`** ‚Äì –¢–∏–ø –ø–æ–¥—ñ—ó, —è–∫–∏–π –≤–∏–∑–Ω–∞—á–∞—î, –≤ —è–∫—É —á–µ—Ä–≥—É —ó—ó —Å–ª—ñ–¥ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ (`OrderCreated`, `UserUpdated` —Ç–æ—â–æ).
- **`Payload`** ‚Äì JSON-–æ–±'—î–∫—Ç —ñ–∑ —Ñ–∞–∫—Ç–∏—á–Ω–∏–º–∏ –¥–∞–Ω–∏–º–∏ –ø–æ–¥—ñ—ó.
- **`CreatedAt`** ‚Äì –ß–∞—Å —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ–¥—ñ—ó.
- **`Processed`** ‚Äì –§–ª–∞–≥, —â–æ –≤–∫–∞–∑—É—î, —á–∏ –±—É–ª–∞ –ø–æ–¥—ñ—è –≤–∂–µ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∞ —É —á–µ—Ä–≥—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å.
- **`ProcessedAt`** ‚Äì –ß–∞—Å, –∫–æ–ª–∏ –ø–æ–¥—ñ—è –±—É–ª–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∞.

---

## **–Ø–∫ `OutboxMessages` –ø—Ä–∞—Ü—é—î —É —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è—Ö?**

–ü—Ä–∏–∫–ª–∞–¥ **—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è (`Order`)** —Ç–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø–æ–¥—ñ—ó –≤ `OutboxMessages`:

```csharp
using (var context = new ApplicationDbContext())
{
    using (var transaction = context.Database.BeginTransaction())
    {
        try
        {
            // 1. –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
            var order = new Order { CustomerId = 1, TotalAmount = 300 };
            context.Orders.Add(order);
            context.SaveChanges();

            // 2. –°—Ç–≤–æ—Ä—é—î–º–æ –ø–æ–¥—ñ—é —ñ –¥–æ–¥–∞—î–º–æ –≤ OutboxMessages
            var outboxMessage = new OutboxMessage
            {
                EventType = "OrderCreated",
                Payload = JsonConvert.SerializeObject(order) // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –æ–±'—î–∫—Ç —É —Ñ–æ—Ä–º–∞—Ç—ñ JSON
            };
            context.OutboxMessages.Add(outboxMessage);
            context.SaveChanges();

            // 3. –ö–æ–º—ñ—Ç–∏–º–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é (Order —ñ –ø–æ–¥—ñ—è –∑–∞–ø–∏—Å–∞–Ω—ñ —Ä–∞–∑–æ–º)
            transaction.Commit();
        }
        catch
        {
            transaction.Rollback(); // –í—ñ–¥–∫–∞—Ç —É—Å—ñ—Ö –∑–º—ñ–Ω, —è–∫—â–æ —Å—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞
        }
    }
}
```

‚úÖ **–ì–∞—Ä–∞–Ω—Ç—ñ—è —É–∑–≥–æ–¥–∂–µ–Ω–æ—Å—Ç—ñ:** –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è (`Order`) —Ç–∞ –ø–æ–¥—ñ—è (`OutboxMessages`) –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è —Ä–∞–∑–æ–º.  
‚ùå **–Ø–∫—â–æ –∑–∞–ø–∏—Å —É RabbitMQ –∑—Ä–æ–±–∏—Ç–∏ —Ç—É—Ç —ñ –≤—ñ–Ω –∑–∞—Ñ–µ–π–ª–∏—Ç—å—Å—è** ‚Äì –ø–æ–¥—ñ—è –º–æ–∂–µ –∑–∞–≥—É–±–∏—Ç–∏—Å—è.

---

## **–û–±—Ä–æ–±–∫–∞ `OutboxMessages` —É —Ñ–æ–Ω—ñ (Background Worker)**

–©–æ–± –ø–æ–¥—ñ—è –±—É–ª–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∞, —Å—Ç–≤–æ—Ä–∏–º–æ **Background Service**, —è–∫–∏–π –ø–µ—Ä—ñ–æ–¥–∏—á–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î `OutboxMessages` —ñ –ø—É–±–ª—ñ–∫—É—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è.

```csharp
public class OutboxProcessor : BackgroundService
{
    private readonly IServiceScopeFactory _scopeFactory;
    private readonly IMessageBus _messageBus;
    private readonly ILogger<OutboxProcessor> _logger;

    public OutboxProcessor(IServiceScopeFactory scopeFactory, IMessageBus messageBus, ILogger<OutboxProcessor> logger)
    {
        _scopeFactory = scopeFactory;
        _messageBus = messageBus;
        _logger = logger;
    }

    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        while (!stoppingToken.IsCancellationRequested)
        {
            try
            {
                using (var scope = _scopeFactory.CreateScope())
                {
                    var context = scope.ServiceProvider.GetRequiredService<ApplicationDbContext>();

                    var messages = await context.OutboxMessages
                        .Where(x => !x.Processed)
                        .ToListAsync(stoppingToken);

                    foreach (var message in messages)
                    {
                        try
                        {
                            // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –ø–æ–¥—ñ—é —É RabbitMQ / Kafka
                            await _messageBus.PublishAsync(message.EventType, message.Payload);

                            // –ü–æ–∑–Ω–∞—á–∞—î–º–æ —è–∫ –æ–±—Ä–æ–±–ª–µ–Ω—É
                            message.Processed = true;
                            message.ProcessedAt = DateTime.UtcNow;

                            await context.SaveChangesAsync(stoppingToken);
                        }
                        catch (Exception ex)
                        {
                            _logger.LogError(ex, "–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –ø–æ–¥—ñ—ó {MessageId}", message.Id);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "–ü–æ–º–∏–ª–∫–∞ —É Outbox Processor");
            }

            await Task.Delay(TimeSpan.FromSeconds(5), stoppingToken);
        }
    }
}
```

---

## **–ß–æ–º—É `OutboxMessages` –∫–æ—Ä–∏—Å–Ω–∏–π?**

### **üîπ 1. –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –≤—Ç—Ä–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å**

–Ø–∫—â–æ RabbitMQ / Kafka **–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π**, –ø–æ–¥—ñ—è **–Ω–µ –∑–∞–≥—É–±–∏—Ç—å—Å—è**, –∞ –∑–∞–ª–∏—à–∏—Ç—å—Å—è –≤ —Ç–∞–±–ª–∏—Ü—ñ `OutboxMessages` –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ—ó —É—Å–ø—ñ—à–Ω–æ—ó —Å–ø—Ä–æ–±–∏.

### **üîπ 2. –ì–∞—Ä–∞–Ω—Ç—ñ—è —É–∑–≥–æ–¥–∂–µ–Ω–æ—Å—Ç—ñ –¥–∞–Ω–∏—Ö**

–Ø–∫—â–æ –∑–∞–ø–∏—Å–∞—Ç–∏ –±—ñ–∑–Ω–µ—Å-–¥–∞–Ω—ñ (`Order`) —ñ –ø–æ–¥—ñ—é –æ–∫—Ä–µ–º–æ, –º–æ–∂–ª–∏–≤–∏–π —Å—Ç–∞–Ω, –∫–æ–ª–∏:

- `Order` –∑–∞–ø–∏—Å–∞–Ω–æ, –∞ `OrderCreated` ‚Äì **–Ω—ñ** (—Å–∏—Å—Ç–µ–º–∞ –≤–ø–∞–ª–∞).
- `OrderCreated` –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ, –∞ `Order` ‚Äì **–Ω—ñ** (–±–∞–∑–∞ –≤–ø–∞–ª–∞).

`OutboxMessages` —É—Å—É–≤–∞—î —Ü—é –ø—Ä–æ–±–ª–µ–º—É –∑–∞ —Ä–∞—Ö—É–Ω–æ–∫ **–æ–¥–Ω—ñ—î—ó —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó**.

### **üîπ 3. –ü–æ–≤—Ç–æ—Ä–Ω–∞ –æ–±—Ä–æ–±–∫–∞**

–Ø–∫—â–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–µ –±—É–ª–æ —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ RabbitMQ, –≤–æ–Ω–æ **–Ω–µ –±—É–¥–µ –≤–∏–¥–∞–ª–µ–Ω–µ** –∑ `OutboxMessages`, —ñ —Ñ–æ–Ω–æ–≤–∏–π –ø—Ä–æ—Ü–µ—Å —Å–ø—Ä–æ–±—É—î –π–æ–≥–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ.

### **üîπ 4. –ú–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω—ñ—Å—Ç—å**

–ú–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ **–∫—ñ–ª—å–∫–∞ —ñ–Ω—Å—Ç–∞–Ω—Å—ñ–≤ —Å–µ—Ä–≤—ñ—Å—ñ–≤**, —è–∫—ñ —Å–ø–æ–∂–∏–≤–∞—é—Ç—å `OutboxMessages`, –¥–æ–∑–≤–æ–ª—è—é—á–∏ —Ä–æ–∑–ø–æ–¥—ñ–ª–∏—Ç–∏ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è.

---

## **–í–∏—Å–Ω–æ–≤–æ–∫**

`OutboxMessages` ‚Äî —Ü–µ **—Ç–∞–±–ª–∏—Ü—è-–±—É—Ñ–µ—Ä**, —è–∫–∞ –¥–æ–∑–≤–æ–ª—è—î –≥–∞—Ä–∞–Ω—Ç—É–≤–∞—Ç–∏ **–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å** –º—ñ–∂ –∑–∞–ø–∏—Å–∞–º–∏ –≤ –ë–î —ñ –ø–æ–¥—ñ—è–º–∏ –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏—Ö —á–µ—Ä–≥–∞—Ö.  
–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è `Outbox Pattern` –≤ **.NET + EF Core** –¥–æ–∑–≤–æ–ª—è—î: ‚úÖ –í–∏–∫–æ–Ω—É–≤–∞—Ç–∏ **–±—ñ–∑–Ω–µ—Å-–æ–ø–µ—Ä–∞—Ü—ñ—ó —Ç–∞ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—é –ø–æ–¥—ñ–π** **–≤ –æ–¥–Ω—ñ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó**.  
‚úÖ –ó–∞–ø–æ–±—ñ–≥–∞—Ç–∏ **–≤—Ç—Ä–∞—Ç—ñ –ø–æ–¥—ñ–π** —É —Ä–∞–∑—ñ –ø–∞–¥—ñ–Ω–Ω—è —á–µ—Ä–≥–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å.  
‚úÖ –ì–∞—Ä–∞–Ω—Ç—É–≤–∞—Ç–∏ **–ø–æ–≤—Ç–æ—Ä–Ω–µ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è** –ø–æ–¥—ñ–π –ø—Ä–∏ –∑–±–æ—è—Ö.

–¶–µ–π –ø–∞—Ç–µ—Ä–Ω —î **–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–∏–º —É –º—ñ–∫—Ä–æ—Å–µ—Ä–≤—ñ—Å–∞—Ö** üöÄ, –¥–µ –ø–æ—Ç—Ä—ñ–±–Ω–∞ **—É–∑–≥–æ–¥–∂–µ–Ω—ñ—Å—Ç—å –º—ñ–∂ –±–∞–∑–æ—é –¥–∞–Ω–∏—Ö —Ç–∞ –ø–æ–¥—ñ—î–≤–æ—é —Å–∏—Å—Ç–µ–º–æ—é (Event-Driven Architecture)**.